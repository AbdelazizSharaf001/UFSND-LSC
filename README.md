# UFSND-LSC
Submission repo for -> UdacityFSND: Linux Server Configuration project

> this file is written step by step as explainatory instructions to facilitate discription.
>
> reviewer data are at the end

---
1. prepare your files
    - it's advisable to use a shell to facilitate your work more than the browser
    - if you want to start the server with your own ssh public key generate it
        * `ssh-keygen` command will do the trick
        * make sure to keep `passphrase` you enter save and remember it
        * you'll need both files generrated as will as this passphrase
    > you'll need to generate key pairs for every user you add to your instance
2. ssh into the server
    - Start a new Ubuntu Linux server instance on Amazon Lightsail.
        * create aws account
        * activate acount
        * login to lightsail
        * hit "Create instance" button
        * choose `"Linux/Unix"`
        * choose `"OS Only"`
        * choose `"Ubuntu 18.04 LTS"` `// any ubuntu should do`
        * to change default ssh key pair
            * click on `"Change SSH key pair"`
            * you could:
                
                choose one of your keys,
                
                click `"Create New"` `site will generate ssh key pair with name you enter`
                
                or click `"Upload New"` to add new `if you completed step (1)`
            * upload public key file
                
                `normally *.pub generated by ssh-keygen // this could be changed so check files contents`
            * whatever you do, you must obtain a copy of the private key you're gonna use
                
                let's say `pk.pem`
         * Choose `Instance plan` you prefer
         * add a unique name for your instance
         * click `"Create instance"`
    - Wait until your instance is being created
    - ensure that your instance is started `if not start it`
    - SSH into the server `two methods`
        * First
            
            from lightsail wibsite using webbrowser
            > don't work well on smart phones
            * Click on the shell icon beside your instance name
            
            or
            * Click on the instance name
                
                or `"Manage"` in the dropdown menu beside it
            * click on `"Connect using SSH"`
        * Second (recommended)
            * click `"Manage"` or your instance name
            * get `Public IP` & `User name`
            * within any shell type
                
                `$ ssh USER_NAME@PUBLIC_IP -p 22 -i /PATH/TO/pk.pem`
            * Server could complain about your file permissins
                
                just set them to be non-accessable files

                this should do: `chmod 600 pk.pem `
3. install packages needed

    `sudo apt install nano git zsh apache2 apache2-utils libapache2-mod-wsgi-py3 python3 python3-pip`
4. Secure instance:
    - Upgrade server
        * upgrade distro
        
        `sudo apt-get dist-upgrade`
        * Update all currently installed packages
        
        `sudo apt update; sudo apt upgrade; sudo apt autoremove; sudo apt autoclean;`
    - configure the Lightsail firewall to allow port 2200
    - configre SSH
    
        update configration rules in `/etc/ssh/sshd_config`
        like this:
        ```bash
        $ sudo nano /etc/ssh/sshd_config
        
        # find and change rules below
        port 2200                   # Change the SSH port from 22 to 2200
        PermitRootLogin no          # stop root from login remotly
        PasswordAuthentication no   # only alow key based authentication
        ```
    - configre UFW
        * Only allow connections for SSH (port 2200), HTTP (port 80), and NTP (port 123).
        ```bash
        sudo ufw default allow outgong
        sudo ufw default deny incoming
        sudo ufw allow 2200/tcp
        sudo ufw allow www
        sudo ufw allow 123/tcp
        sudo ufw enable
        ```
    - delete ssh rule from lightsail configration
        
        make sure it's ssh default that you delete, not 2200 you added
4. user management
    - Create a new user account named grader
    
      `sudo adduser grader`
    - Give grader the superuser permission with no password
    
      ```bash
      $ sudo cp /etc/sudoers.d/90-cloud-init-users /etc/sudoers.d/grader
      $ sudo nano /etc/sudoers.d/grader
      grader ALL=(ALL) NOPASSWD:ALL
      ```
    - set ssh key for grader
      
      generate a new ssh key pair like step (1), then follow this code:
      ```bash
      cd /home/grader/
      mkdir .ssh
      sudo nano .ssh/authorized_keys
      ```
      copy/paste public key you generated inside it
    - login with grader using the private key you generated for it
5. deployment
    - get iCatalog from git repo
    
        `git clone https://github.com/AbdelazizSharaf001/iCatalog.git`
    - install dpendances via `pip`, `pip3` , `pipenv`.. etc.
    - database
        
        engine: SQLALCHEMY [flask extention]
        
        project uses `sqlite3` so only sqlalchemy is enough here to be installed cia `pip`
        
        > recommended database type `postgresql` is not used for this project but it's configured for future migration
        > 
        > steps by code
        >   ```
        >   # set postgresql version to install
        >   # here we go with latest (v12 for now)
        >   wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
        >   echo "deb [arch=amd64] http://apt.postgresql.org/pub/repos/apt/ `lsb_release -cs`-pgdg main" |sudo tee /etc/apt/sources.list.d/pgdg.list
        >   
        >   # update to feche version installation
		>	sudo apt update
        >   
        >   # install postgresql v12
        >   sudo apt install postgresql-12 postgresql-client-12
        >   
        >   # restart service to ensure it's added and running
		>   sudo service postgresql restart
        >   
        >   # connect to psql server
        >   sudo -u postgres psql
        >   
        >   # create new user
        >   postgres=# CREATE USER catalog password 'STRONG_PASSWORD';
        >   
        >   # create database and give ownership to new created user
        >   postgres=# CREATE DATABASE iCatalog OWNER catalog;
        >   ```
        > after this process your database URI for engine should be like this
        >
        >   `postgresql://catalog:YOUR_PASSWORD@localhost/icatalog`
        >
        > for now we will use sqlite as mentioned
    - server configration
        * apache and it's related packages is instailled in step 2
        * `sudo nano /etc/apache2/sites-enabled/000-default.conf`
            ```
            <VirtualHost *:80>
                # The ServerName directive sets the request scheme, hostname and port that
                # the server uses to identify itself. This is used when creating
                # redirection URLs. In the context of virtual hosts, the ServerName
                # specifies what hostname must appear in the request's Host: header to
                # match this virtual host. For the default virtual host (this file) this
                # value is not decisive as it is used as a last resort host regardless.
                # However, you must set it for any further virtual host explicitly.
                #ServerName www.example.com

                ServerAdmin webmaster@localhost
                DocumentRoot /var/www/html/iCatalog

                # Available loglevels: trace8, ..., trace1, debug, info, notice, warn,
                # error, crit, alert, emerg.
                # It is also possible to configure the loglevel for particular
                # modules, e.g.
                #LogLevel info ssl:warn

                ErrorLog ${APACHE_LOG_DIR}/error.log
                CustomLog ${APACHE_LOG_DIR}/access.log combined

                # For most configuration files from conf-available/, which are
                # enabled or disabled at a global level, it is possible to
                # include a line for only one particular virtual host. For example the
                # following line enables the CGI configuration for this host only
                # after it has been globally disabled with "a2disconf".
                #Include conf-available/serve-cgi-bin.conf

                WSGIScriptAlias / /var/www/html/iCatalog/wsgi.py
                WSGIDaemonProcess yourapplication user=grader group=grader threads=5

                <Directory /var/www/yourapplication>
                    WSGIProcessGroup yourapplication
                    WSGIApplicationGroup %{GLOBAL}
                    Order deny,allow
                    Allow from all
                    Require all granted
                </Directory>
            </VirtualHost>
            ```
        * for linux problems with file permmisions, modify apache user
            
            `sudo nano /etc/apache2/apache2.conf`
            ```
            User grader
            ```
            These could be also set in `/etc/apache2/envvars`
        * `sudo service apache2 restart`
6. if all things have gone right
    
    go to your server PUBLIC_IP,
    
    congratulations for myself as well as you,
    here is our site


# third-party resources
> going along with the guide above shold make you reach what you nead but databases always have complains
>
> sqlite choosen is the least one to complain with SQLALCHEMY but let read some docs and projects examples for enhancment

1. [sqlalchemy docs](https://docs.sqlalchemy.org/en/13/)
2. [flask-sqlalchemy docs](https://flask-sqlalchemy.palletsprojects.com/en/2.x/)
3. [realpython >> Flask by Example â€“ Setting up Postgres, SQLAlchemy, and Alembic](https://realpython.com/flask-by-example-part-2-postgres-sqlalchemy-and-alembic/)
    > you need to go with the new versions and to install flask extentions
4. [hackernoon >> flask from scrach](https://hackernoon.com/flask-web-programming-from-scratch-9ada8088fde1)


# Reviewer data

ip:         18.191.236.251

port:       2200

ssh_key:    { provided in "Notes to Reviewer" }
